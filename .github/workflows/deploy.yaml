name: "Deploy Users ðŸš€ðŸš€"

on: 
    workflow_dispatch:
    push:
        branches:
            - main

permissions:
  id-token: write
  contents: read

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: "Checkout repository âš’ï¸"
              uses: actions/checkout@v4
            - name: "âš™ï¸ Setup .NET 8"
              uses: actions/setup-dotnet@v4
              with:
                dotnet-version: 8.x
            - name: "Restore dependencies ðŸ—³ï¸"
              run: dotnet restore ./UsersAuthorization.csproj
            - name: "Build project ðŸ—ï¸ðŸ‘·â€â™€ï¸"
              run: dotnet build ./UsersAuthorization.csproj --no-restore
            - name: "Run Tests âœ…âœ…"
              run: dotnet test ./UsersAuthorization.csproj --no-build --verbosity normal
    
    publish:
        needs: build
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        steps:
          - name: ðŸ› ï¸ Checkout Repository
            uses: actions/checkout@v4

          - name: âš™ï¸ Setup .NET 8 SDK
            uses: actions/setup-dotnet@v4
            with:
              dotnet-version: 8.x
          - name: "â¬†ï¸Load Env"
            run: |
              echo "ConnectionStrings__dbConnectionUsers=${{ secrets.DB_USERS }}" >> $GITHUB_ENV
              echo "APISettings__JwtOptions__Secret=${{ secrets.JWT_SECRET }}" >> $GITHUB_ENV
              echo "APISettings__JwtOptions__Issuer=${{ secrets.JWT_ISSUER }}" >> $GITHUB_ENV
              echo "APISettings__JwtOptions__Audience=${{ secrets.JWT_AUDIENCE }}" >> $GITHUB_ENV
              echo "RabbitMQ__Host=${{ secrets.HOST_RABBIT }}" >> $GITHUB_ENV
              echo "RabbitMQ__Port=${{ secrets.PORT_RABBIT }}" >> $GITHUB_ENV
              echo "RabbitMQ__Username=${{ secrets.USERNAME_RABBIT }}" >> $GITHUB_ENV
              echo "RabbitMQ__Password=${{ secrets.PASSWORD_RABBIT }}" >> $GITHUB_ENV

          - name: ðŸ”„ Replace Env Variables in Task Definition
            run: |
                ecs_task_definition=$(envsubst < ./deployments/e-sports-revision1.json)

                echo "$ecs_task_definition"

                aws ecs register-task-definition \
                  --cli-input-json "$ecs_task_definition"
            env:
              DB_USERS: ${{ secrets.DB_USERS }}
              JWT_SECRET: ${{ secrets.JWT_SECRET }}
              JWT_ISSUER: ${{ secrets.JWT_ISSUER }}
              JWT_AUDIENCE: ${{ secrets.JWT_AUDIENCE }}
              HOST_RABBIT: ${{ secrets.HOST_RABBIT }}
              USERNAME_RABBIT: ${{ secrets.USERNAME_RABBIT }}
              PASSWORD_RABBIT: ${{ secrets.PASSWORD_RABBIT }}

          - name: ðŸ” Configure AWS Credentials
            uses: aws-actions/configure-aws-credentials@v4
            with:
              role-skip-session-tagging: true
              aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              aws-region: us-east-2

          - name: ðŸ”‘ Login to Amazon ECR
            run: aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin ${{ secrets.REPOSITORY }}

          - name: ðŸ“¦ Publish Docker Image to Amazon ECR
            working-directory: .
            run: |
              REPO="${{ secrets.REPOSITORY }}"
    
              if [[ -z "$REPO" ]]; then
                echo "Error: secrets.REPOSITORY is empty or is not configured correctly"
                exit 1
              fi
              
              echo "Using repository: $REPO"

              dotnet publish -c Release -r linux-x64 --self-contained false

              if [ ! -f "Dockerfile" ]; then
                echo "Error: Docker file not found in current directory."
                exit 1
              fi

              docker build  \
              --build-arg ConnectionStrings__dbConnectionUsers="${{ secrets.DB_USERS }}" \
              --build-arg APISettings__JwtOptions__Secret="${{ secrets.JWT_SECRET }}" \
              --build-arg APISettings__JwtOptions__Issuer="${{ secrets.JWT_ISSUER }}" \
              --build-arg APISettings__JwtOptions__Audience="${{ secrets.JWT_AUDIENCE }}" \
              --build-arg RabbitMQ__Host="${{ secrets.HOST_RABBIT }}" \
              --build-arg RabbitMQ__Port="${{ secrets.PORT_RABBIT }}" \
              --build-arg RabbitMQ__Username="${{ secrets.USERNAME_RABBIT }}" \
              --build-arg RabbitMQ__Password="${{ secrets.PASSWORD_RABBIT }}" \
              -t  "$REPO:latest" .
              
              docker push "$REPO:latest"

    deploy:
      needs: publish
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      runs-on: ubuntu-latest
      steps:
        - name: ðŸ› ï¸ Checkout Repository
          uses: actions/checkout@v4

        - name: ðŸ” Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: us-east-2
        - name: ðŸš€ Deploy to Amazon ECS
          uses: aws-actions/amazon-ecs-deploy-task-definition@v2
          with:
            cluster: ESports
            task-definition: ./deployments/e-sports-revision1.json
            service: users-container
            wait-for-service-stability: true